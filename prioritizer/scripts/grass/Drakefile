
GRASSDATA="/home/klsvd/GRASSDATA/"
LOCATION=DV
MAPSET=PERMANENT

LOCATION_PATH=$[GRASSDATA]/$[LOCATION]
PERMANENT_PATH=$[LOCATION_PATH]/PERMANENT

GISBASE=$(grass --config path)

RASTER_RESOLUTION=150


$[PERMANENT_PATH], %createDB <- [-timecheck]
    ./createDB.sh $[LOCATION_PATH] 
    export GRASS_BATCH_JOB="./setDefaultRegion.sh"
    grass $[PERMANENT_PATH]
    unset GRASS_BATCH_JOB
    
set_resolution.log, %set_resolution <- $[PERMANENT_PATH] [-timecheck]
    grass $[PERMANENT_PATH] <<EOF             
        g.region res=$RASTER_RESOLUTION -p > $[OUTPUT]
    EOF

set_BBOX.log, %set_BBOX <- logg_composite.log, %logg_composite
    grass $[PERMANENT_PATH] <<EOF             
        g.region vect=logg_composite -p > $[OUTPUT]
    EOF


; Импорт исходных данных
import_roads.log, %import_roads, %import_vector, %import_all <- $[PERMANENT_PATH] [-timecheck]
    export GRASS_BATCH_JOB="./import_roads.sh"
    grass $[PERMANENT_PATH] 2> $[OUTPUT]
    unset GRASS_BATCH_JOB

import_vud.log, %import_vud, %import_vector, %import_all <- $[PERMANENT_PATH] [-timecheck]
    export GRASS_BATCH_JOB="./import_vud.sh"
    grass $[PERMANENT_PATH] 2> $[OUTPUT]
    unset GRASS_BATCH_JOB

import_declarations.log, %import_declarations, %import_vector, %import_all <- $[PERMANENT_PATH] [-timecheck]
    export GRASS_BATCH_JOB="./import_declarations.sh"
    grass $[PERMANENT_PATH] 2> $[OUTPUT]
    unset GRASS_BATCH_JOB


import_logging.log, %import_logging, %import_vector, %import_all <- $[PERMANENT_PATH] [-timecheck]
    echo "Заглушка: пока данных по рубкам нет" > $[OUTPUT]
    grass $[PERMANENT_PATH] <<EOF             
        v.edit map=logging tool=create --o
    EOF


import_settlements.log, %import_settlements, %import_vector, %import_all <- $[PERMANENT_PATH] [-timecheck]
    export GRASS_BATCH_JOB="./import_settlements.sh"
    grass $[PERMANENT_PATH] 2> $[OUTPUT]
    unset GRASS_BATCH_JOB


; Создание композитного слоя всех имеющихся рубок и деклараций
logg_composite.log, %logg_composite <- import_declarations.log, %import_declarations, import_logging.log, %import_logging
    grass $[PERMANENT_PATH] <<EOF             
        v.patch input=declar_prim16,logging out=logg_composite --o 2> $[OUTPUT]
    EOF



; Растеризация
rasterize_roads.log, %rasterize_roads, %raster_operations <- import_roads.log, %import_roads, set_resolution.log, %set_resolution, set_BBOX.log, %set_BBOX
    export GRASS_BATCH_JOB="./vect_roads_to_rast.sh"
    grass $[PERMANENT_PATH] 2> $[OUTPUT]
    unset GRASS_BATCH_JOB

rasterize_vud.log, %rasterize_vud, %raster_operations <- import_vud.log, %import_vud, set_resolution.log, %set_resolution, set_BBOX.log, %set_BBOX
    export GRASS_BATCH_JOB="./vect_vud_to_rast.sh"
    grass $[PERMANENT_PATH] 2> $[OUTPUT]
    unset GRASS_BATCH_JOB

rasterize_settlements.log, %rasterize_settlements, %raster_operations <- import_settlements.log, %import_settlements, set_resolution.log, %set_resolution, set_BBOX.log, %set_BBOX
    grass $[PERMANENT_PATH] <<EOF > $[OUTPUT]
        v.to.rast type=area input=settlements output=settlements use=val --o
    EOF


background.log, %background, %raster_operations <- set_resolution.log, %set_resolution, set_BBOX.log, %set_BBOX
    grass $[PERMANENT_PATH] <<EOF             
        r.mapcalc expression="background = 1" --o 2> $[OUTPUT]
    EOF

; Создание композитного слоя точек продаж
create_stocks.log, %create_stocks <- rasterize_settlements.log, %rasterize_settlements, rasterize_roads.log, %rasterize_roads
    grass $[PERMANENT_PATH] <<EOF > $[OUTPUT]
        r.patch input=settlements,roads_railway output=wood_stock
    EOF


; Файл стоимостей движения по типам покрытия:
road_costs.csv <- [-timechek]
    cat <<EOF > $[OUTPUT]
    roads_railway: 0.0
    roads_asfalt: 3.0
    roads_good_grunt: 5.0
    roads_grunt: 6.0
    roads_land: 7.0
    roads_other: 10.0
    roads_trop: 10.0
    background: 20.0
    EOF

; Рассчет расстояний
dist_to_roads.log, %dist_to_roads, %raster_operations <- rasterize_roads.log, %rasterize_roads
    export GRASS_BATCH_JOB="./dist_to_roads.sh"
    grass $[PERMANENT_PATH] 2> $[OUTPUT]
    unset GRASS_BATCH_JOB

delivery_cost.log, %delivery_cost <- road_costs.csv, create_stocks.log, %create_stocks, rasterize_roads.log, %rasterize_roads, background.log, %background
    python ./cost_of_delivery.py --result delivery_cost --cost_data=$[INPUT] --stocks=wood_stock --overwrite



