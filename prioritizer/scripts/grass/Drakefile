
RESULT_DIR=results

GRASSDATA="/home/klsvd/GRASSDATA/"
LOCATION=DV
MAPSET=PERMANENT

LOCATION_PATH=$[GRASSDATA]/$[LOCATION]
PERMANENT_PATH=$[LOCATION_PATH]/PERMANENT

GISBASE=$(grass --config path)

RASTER_RESOLUTION=100


$[PERMANENT_PATH], %createDB <- [-timecheck]
    ./createDB.sh $[LOCATION_PATH] 
    export GRASS_BATCH_JOB="./setDefaultRegion.sh"
    grass $[PERMANENT_PATH]
    unset GRASS_BATCH_JOB
    
set_resolution.log, %set_resolution <- $[PERMANENT_PATH] [-timecheck]
    grass $[PERMANENT_PATH] <<EOF             
        g.region res=$RASTER_RESOLUTION -p > $[OUTPUT]
    EOF

; set_BBOX.log, %set_BBOX <- import_wood_stocks.log, %import_wood_stocks
;    grass $[PERMANENT_PATH] <<EOF             
;        g.region vect=wood_stocks -p > $[OUTPUT]
;    EOF
    

remove_mask.log, %remove_mask, %raster_operations <- $[PERMANENT_PATH] [-timecheck]
    echo "Try to remove mask" >  $[OUTPUT]
    grass $[PERMANENT_PATH] <<EOF
        g.remove type=rast name="MASK" -f 2>> $[OUTPUT] 
    EOF
    echo "Mask removed" >>  $[OUTPUT]


; Импорт исходных данных

import_AOI.log, %import_AOI, %import_vector, %import_all <- $[PERMANENT_PATH] [-timecheck]
    export GRASS_BATCH_JOB="./import_aoi.sh"
    grass $[PERMANENT_PATH] 2> $[OUTPUT]
    unset GRASS_BATCH_JOB

import_roads.log, %import_roads, %import_vector, %import_all <- $[PERMANENT_PATH] [-timecheck]
    export GRASS_BATCH_JOB="./import_roads.sh"
    grass $[PERMANENT_PATH] 2> $[OUTPUT]
    unset GRASS_BATCH_JOB

import_vud.log, %import_vud, %import_vector, %import_all <- $[PERMANENT_PATH] [-timecheck]
    export GRASS_BATCH_JOB="./import_vud.sh"
    grass $[PERMANENT_PATH] 2> $[OUTPUT]
    unset GRASS_BATCH_JOB

import_declarations.log, %import_declarations, %import_vector, %import_all <- $[PERMANENT_PATH] [-timecheck]
    export GRASS_BATCH_JOB="./import_declarations.sh"
    grass $[PERMANENT_PATH] 2> $[OUTPUT]
    unset GRASS_BATCH_JOB


import_logging.log, %import_logging, %import_vector, %import_all <- $[PERMANENT_PATH] [-timecheck]
    echo "Заглушка: пока данных по рубкам нет" > $[OUTPUT]
    grass $[PERMANENT_PATH] <<EOF             
        v.edit map=logging tool=create --o
    EOF


import_settlements.log, %import_settlements, %import_vector, %import_all <- $[PERMANENT_PATH] [-timecheck]
    export GRASS_BATCH_JOB="./import_settlements.sh"
    grass $[PERMANENT_PATH] 2> $[OUTPUT]
    unset GRASS_BATCH_JOB

import_wood_stocks.log, %import_wood_stocks, %import_vector, %import_all <- $[PERMANENT_PATH] [-timecheck]
    export GRASS_BATCH_JOB="./import_stocks.sh"
    grass $[PERMANENT_PATH] 2> $[OUTPUT]
    unset GRASS_BATCH_JOB



; Создание композитного слоя всех имеющихся рубок и деклараций
logg_composite.log, %logg_composite <- import_declarations.log, %import_declarations, import_logging.log, %import_logging
    grass $[PERMANENT_PATH] <<EOF             
        v.patch input=declar_prim16,logging out=logg_composite --o 2> $[OUTPUT]
    EOF



; Растеризация
create_AOI_mask.log, %create_AOI_mask, %raster_operations <- import_AOI.log, %import_AOI, set_resolution.log, %set_resolution, remove_mask.log, %remove_mask
    grass $[PERMANENT_PATH] <<EOF > $[OUTPUT]
        g.region vect=AOI
        v.to.rast type=area input=AOI output=AOI use=val --o
        r.mask raster=AOI
    EOF
    

rasterize_roads.log, %rasterize_roads, %raster_operations <- import_roads.log, %import_roads, create_AOI_mask.log, %create_AOI_mask
    export GRASS_BATCH_JOB="./vect_roads_to_rast.sh"
    grass $[PERMANENT_PATH] 2> $[OUTPUT]
    unset GRASS_BATCH_JOB

rasterize_vud.log, %rasterize_vud, %raster_operations <- import_vud.log, %import_vud, create_AOI_mask.log, %create_AOI_mask
    export GRASS_BATCH_JOB="./vect_vud_to_rast.sh"
    grass $[PERMANENT_PATH] 2> $[OUTPUT]
    unset GRASS_BATCH_JOB


rasterize_wood_stocks.log, %rasterize_wood_stocks, %raster_operations <- import_wood_stocks.log, %import_wood_stocks, create_AOI_mask.log, %create_AOI_mask
    grass $[PERMANENT_PATH] <<EOF > $[OUTPUT]
        v.to.rast type=point input=wood_stocks output=wood_stocks use=val --o
    EOF


background.log, %background, %raster_operations <- create_AOI_mask.log, %create_AOI_mask
    grass $[PERMANENT_PATH] <<EOF             
        r.mapcalc expression="background = 1" --o 2> $[OUTPUT]
    EOF

; Создание композитного слоя точек продаж
create_stocks_comp.log, %create_stocks_comp <- rasterize_wood_stocks.log, %rasterize_wood_stocks, rasterize_roads.log, %rasterize_roads
    grass $[PERMANENT_PATH] <<EOF > $[OUTPUT]
        r.patch input=wood_stocks,roads_railway output=wood_stocks_comp
    EOF


; Файл стоимостей движения по типам покрытия:
road_costs.csv <- [-timecheck]
    cat <<EOF > $[OUTPUT]
    roads_railway: 0.0
    roads_asfalt: 0.30
    roads_good_grunt: 0.50
    roads_grunt: 0.60
    roads_land: 0.70
    roads_other: 0.100
    roads_trop: 1.00
    background: 2.50
    EOF

; Рассчет расстояний
dist_to_roads.log, %dist_to_roads, %raster_operations <- rasterize_roads.log, %rasterize_roads, create_AOI_mask.log, %create_AOI_mask
    export GRASS_BATCH_JOB="./dist_to_roads.sh"
    grass $[PERMANENT_PATH] 2> $[OUTPUT]
    unset GRASS_BATCH_JOB

delivery_cost.log, %delivery_cost <- road_costs.csv, create_stocks_comp.log, %create_stocks_comp, rasterize_roads.log, %rasterize_roads, background.log, %background
    python ./cost_of_delivery.py --result delivery_cost --cost_data=$[INPUT] --stocks=wood_stocks_comp --overwrite
    touch $[OUTPUT]


; Экспорт результатов
$[RESULT_DIR], %make_output_dir <- [-timecheck]
    mkdir -p $[OUTPUT]

$[RESULT_DIR]/delivery_cost_rgb.tif, %delivery_cost_to_RGB, %raster_operations  <- delivery_cost.log, %delivery_cost, %make_output_dir
    export GRASS_BATCH_JOB="./delivery_to_RGB.sh"
    grass $[PERMANENT_PATH]
    unset GRASS_BATCH_JOB

