#/bin/python

# -*- coding: utf-8  -*-

#%Module
#% description: Create NNet
#%End
#%option
#% key: input
#% type: string
#% description: prefixes of the input raster maps (e.g. clean.LC81120272015333LGN00)
#% required : yes
#% multiple: yes
#%end
#%option
#% key: band_prefix
#% type: string
#% description: band name (e.g. _B3)
#% required : yes
#% multiple: yes
#%end
#%option
#% key: output
#% type: string
#% description: name for result raster maps
#% required : yes
#% multiple: no
#%end


import os, sys
import uuid
from string import Template


if "GISBASE" not in os.environ:
    print "You must be in GRASS GIS to run this program."
    sys.exit(1)

import grass.script as grass


def main(options, flags):
    in_maps = options['input']
    bands = options['band_prefix']
    out_map = options['output']

    in_maps = in_maps.split(',')
    assert len(in_maps) == 5
    bands = bands.split(',')
    assert len(bands) == 5

    vars = dict()
    vars['OUT_NEURON1'] = out_map

    # Normalization
    i = 1
    # for map_id in in_maps:
    for b in bands:
        rasters = [map_id + b for map_id in in_maps]
        
        tmp_mean = 't' + uuid.uuid4().hex
        grass.run_command('r.series', input=','.join(rasters), method='average', output=tmp_mean)

        for rast in rasters:
            varname = 'INPUT'+str(i)
            vars[varname] = 'var_' + str(i) +'_' + uuid.uuid4().hex
            expr = "%s = %s - %s" %(vars[varname], rast, tmp_mean)
            print expr
            grass.mapcalc(expr)
            i +=1

        grass.run_command('g.remove', type='rast', name=tmp_mean, flags='f')


    NET = Template("""eval( \ 
        HNEURON_POT1=8.66064137575252 +$INPUT1*18.7387437184022+$INPUT2*15.1773541680865+$INPUT3*4.58473360782842+$INPUT4*4.86119412469947+$INPUT5*-0.631285199579308+$INPUT6*-0.86129052395368+$INPUT7*2.74305296753787+$INPUT8*1.5789268093729+$INPUT9*-0.744777676666299+$INPUT10*-15.5280304114189+$INPUT11*-6.64583680035143+$INPUT12*-10.4548729872225+$INPUT13*1.53019579582945+$INPUT14*-0.0189733099223287+$INPUT15*3.29409752327386+$INPUT16*-18.458613724394+$INPUT17*-8.87466120944128+$INPUT18*-7.4887805190031+$INPUT19*-8.9309986288132+$INPUT20*7.24331562671699+$INPUT21*7.27201652639167+$INPUT22*1.39767661402281+$INPUT23*-0.0465727888353983+$INPUT24*4.82268571178432+$INPUT25*5.5590489345785 , \ 
        HIDDEN1 = 1/(1+exp(-HNEURON_POT1)) , \ 
        HNEURON_POT2=2.22483513100951 +$INPUT1*-16.7020635823351+$INPUT2*-29.39929473909+$INPUT3*-5.75769345399317+$INPUT4*25.8800113955993+$INPUT5*-2.61702308412158+$INPUT6*15.656692894799+$INPUT7*16.7912062211874+$INPUT8*-19.9219261060727+$INPUT9*-7.52855893696485+$INPUT10*7.52712313816992+$INPUT11*-17.5849923526766+$INPUT12*3.78915591871738+$INPUT13*20.5164208178218+$INPUT14*-6.27822182848473+$INPUT15*8.79410985035957+$INPUT16*29.7925229779393+$INPUT17*2.44733115560463+$INPUT18*-0.319228172974415+$INPUT19*-19.6002374223597+$INPUT20*-6.11598278495318+$INPUT21*-11.2250712567836+$INPUT22*6.33347982544379+$INPUT23*5.56656971578598+$INPUT24*7.57190243754875+$INPUT25*-7.47824445164117 , \ 
        HIDDEN2 = 1/(1+exp(-HNEURON_POT2)) , \ 
        HNEURON_POT3=0.23538741058299 +$INPUT1*15.003288656091+$INPUT2*8.97432486482309+$INPUT3*4.29261836507176+$INPUT4*11.6013373953948+$INPUT5*-26.8045616538538+$INPUT6*14.3645044205327+$INPUT7*13.0861935509345+$INPUT8*-1.73933147470397+$INPUT9*1.96816509681686+$INPUT10*-23.751370021572+$INPUT11*-27.3715752898171+$INPUT12*-19.2127269084316+$INPUT13*18.8684914795937+$INPUT14*-10.955391411418+$INPUT15*36.82518741204+$INPUT16*-6.67066995115579+$INPUT17*0.262878957222249+$INPUT18*-10.7211913118404+$INPUT19*-11.6280377787688+$INPUT20*1.88275169434229+$INPUT21*4.67874014317904+$INPUT22*-3.23618868722382+$INPUT23*-10.7035579383346+$INPUT24*9.01416947875197+$INPUT25*11.8915109281275 , \ 
        HIDDEN3 = 1/(1+exp(-HNEURON_POT3)) , \ 
        HNEURON_POT4=-3.22900009958562 +$INPUT1*9.12835627987182+$INPUT2*20.5822732173829+$INPUT3*7.31312439975051+$INPUT4*-11.7893426048207+$INPUT5*-25.9857623694218+$INPUT6*18.5809749976756+$INPUT7*8.18349390400936+$INPUT8*-17.2822704129991+$INPUT9*-18.2633449729978+$INPUT10*13.4934061601496+$INPUT11*-17.7872902155469+$INPUT12*-6.72654740362078+$INPUT13*-9.06792289241118+$INPUT14*-10.4795493184787+$INPUT15*25.6604692261008+$INPUT16*-12.3232787681397+$INPUT17*-29.4845892248984+$INPUT18*-0.160068344279329+$INPUT19*7.70134034896794+$INPUT20*8.9983506413226+$INPUT21*2.48096185538964+$INPUT22*7.55630362784344+$INPUT23*19.1716717262262+$INPUT24*32.7997757333215+$INPUT25*-22.2641164719752 , \ 
        HIDDEN4 = 1/(1+exp(-HNEURON_POT4)) , \ 
        HNEURON_POT5=1.87774379003683 +$INPUT1*-9.03505443580459+$INPUT2*-9.36529819066763+$INPUT3*-7.9083414332571+$INPUT4*-7.53833647644344+$INPUT5*18.1317711560251+$INPUT6*13.3868703087665+$INPUT7*10.6598524226345+$INPUT8*3.21479216482559+$INPUT9*-6.18032029769398+$INPUT10*-7.95736554788188+$INPUT11*-32.533366068121+$INPUT12*-3.59368223815387+$INPUT13*-12.500540071297+$INPUT14*36.2912193285684+$INPUT15*-11.7914165551554+$INPUT16*-2.32683521334616+$INPUT17*-6.84825883287635+$INPUT18*11.5094258502489+$INPUT19*-5.79633071997021+$INPUT20*-1.21954466557468+$INPUT21*30.5493998323921+$INPUT22*9.16945735127706+$INPUT23*5.69709857400928+$INPUT24*-16.9058152036585+$INPUT25*2.79246134832736 , \ 
        HIDDEN5 = 1/(1+exp(-HNEURON_POT5)) , \ 
        HNEURON_POT6=-3.15445672787756 +$INPUT1*5.60545595186971+$INPUT2*-7.43018448368616+$INPUT3*-0.768863881259526+$INPUT4*12.1402802906516+$INPUT5*7.31212036291277+$INPUT6*3.53606563727126+$INPUT7*8.66175352292211+$INPUT8*6.57163631040846+$INPUT9*9.05251034087498+$INPUT10*-8.56713672436213+$INPUT11*-23.2154295474955+$INPUT12*-13.7128895725458+$INPUT13*8.48723928871287+$INPUT14*-5.02234581863779+$INPUT15*-14.1589378481422+$INPUT16*-4.30281144989886+$INPUT17*-9.60234810137605+$INPUT18*-3.33616906819429+$INPUT19*-9.47864460496861+$INPUT20*-8.96539038602539+$INPUT21*18.43971351951+$INPUT22*22.005000930456+$INPUT23*-11.0467900909477+$INPUT24*-6.70011430639703+$INPUT25*24.5328282520301 , \ 
        HIDDEN6 = 1/(1+exp(-HNEURON_POT6)) , \ 
        HNEURON_POT7=2.84685857569149 +$INPUT1*39.923008278182+$INPUT2*7.36987364227609+$INPUT3*-34.8334895449247+$INPUT4*-33.4312274670258+$INPUT5*9.02590106525511+$INPUT6*3.78222451072458+$INPUT7*-5.10275596375269+$INPUT8*-9.1720510110891+$INPUT9*1.68665691880853+$INPUT10*4.55350548834665+$INPUT11*-6.89634978660358+$INPUT12*1.10090890655952+$INPUT13*25.6112205706729+$INPUT14*-8.72611598403986+$INPUT15*0.932854942202173+$INPUT16*-5.37981790728171+$INPUT17*1.05255495436334+$INPUT18*22.1476842662721+$INPUT19*8.62269329057298+$INPUT20*-5.88735447076794+$INPUT21*-31.3585505765286+$INPUT22*-4.42740136467073+$INPUT23*-3.71194150762556+$INPUT24*31.8799408444616+$INPUT25*-8.62230003463908 , \ 
        HIDDEN7 = 1/(1+exp(-HNEURON_POT7)) , \ 
        HNEURON_POT8=6.11574885193141 +$INPUT1*-4.86467901309154+$INPUT2*-8.53836357514635+$INPUT3*-18.1394184825498+$INPUT4*-29.2777639302942+$INPUT5*41.8262430252418+$INPUT6*21.9737582552922+$INPUT7*25.4561424794482+$INPUT8*7.54438492378402+$INPUT9*13.2615259985433+$INPUT10*12.1037829133927+$INPUT11*-11.5332393479139+$INPUT12*-1.60401328642898+$INPUT13*12.7054128450693+$INPUT14*-9.18704984381913+$INPUT15*-20.5497610909687+$INPUT16*2.86205543371653+$INPUT17*-9.80512137333047+$INPUT18*-10.2136126328821+$INPUT19*-4.1124490283878+$INPUT20*0.516726584668579+$INPUT21*-8.35313336289787+$INPUT22*-5.43994416911442+$INPUT23*8.12884337158074+$INPUT24*29.2826132766543+$INPUT25*-33.9656799582432 , \ 
        HIDDEN8 = 1/(1+exp(-HNEURON_POT8)) , \ 
        HNEURON_POT9=11.7822689909409 +$INPUT1*2.2317814117528+$INPUT2*2.83712764008621+$INPUT3*2.59182391103266+$INPUT4*0.596622907058569+$INPUT5*0.844344164325238+$INPUT6*0.942704901051737+$INPUT7*1.13355844808451+$INPUT8*-0.0505967595012822+$INPUT9*2.49085054974279+$INPUT10*3.35072452278348+$INPUT11*1.0275807734204+$INPUT12*1.45190378382088+$INPUT13*0.915725998773101+$INPUT14*2.55445040390781+$INPUT15*3.62117007659241+$INPUT16*0.937459578821962+$INPUT17*-0.406276534025784+$INPUT18*0.793225830954863+$INPUT19*1.00528819961634+$INPUT20*-1.005670143976+$INPUT21*-5.05224455602834+$INPUT22*-4.84436692225092+$INPUT23*-4.26650702781072+$INPUT24*-6.82530093915371+$INPUT25*-6.81657153457792 , \ 
        HIDDEN9 = 1/(1+exp(-HNEURON_POT9)) , \ 
        HNEURON_POT10=4.9639121168609 +$INPUT1*1.87152231243579+$INPUT2*1.94056072687955+$INPUT3*-2.38443356766594+$INPUT4*-1.31402823708577+$INPUT5*0.398241188389676+$INPUT6*14.0090960953674+$INPUT7*13.3030937671589+$INPUT8*20.938889645944+$INPUT9*5.84974919703568+$INPUT10*-11.9931000792758+$INPUT11*-8.76873147316915+$INPUT12*-14.4973210777872+$INPUT13*-11.8697297952172+$INPUT14*-7.6756207163664+$INPUT15*3.19686636843082+$INPUT16*-1.73199117878781+$INPUT17*1.21702376263565+$INPUT18*4.9569476298154+$INPUT19*7.71353328287095+$INPUT20*1.65986239877334+$INPUT21*-5.35222492270534+$INPUT22*-2.02624025817272+$INPUT23*-11.585503043059+$INPUT24*-4.56363206581302+$INPUT25*6.66497103777565 , \ 
        HIDDEN10 = 1/(1+exp(-HNEURON_POT10)) , \ 
        HNEURON_POT11=13.7237113549641 +$INPUT1*3.15691006878157+$INPUT2*3.75203095390746+$INPUT3*3.32401730065815+$INPUT4*0.32146885053605+$INPUT5*0.0770378766969299+$INPUT6*0.948129279599211+$INPUT7*1.37130486054102+$INPUT8*0.0164608589322142+$INPUT9*3.80783893508843+$INPUT10*4.98883475114279+$INPUT11*0.905384347284126+$INPUT12*1.41894586034025+$INPUT13*1.11579239367538+$INPUT14*3.20691448604682+$INPUT15*3.98108531927755+$INPUT16*1.68937786386498+$INPUT17*-0.728242019341809+$INPUT18*0.388722408347116+$INPUT19*0.800887298319548+$INPUT20*-2.59422898556248+$INPUT21*-6.92748724347787+$INPUT22*-5.99646630138497+$INPUT23*-4.84857646184717+$INPUT24*-8.14788660486255+$INPUT25*-6.52877612092257 , \ 
        HIDDEN11 = 1/(1+exp(-HNEURON_POT11)) , \ 
        HNEURON_POT12=1.87519827638929 +$INPUT1*40.8162315792164+$INPUT2*31.7121366995471+$INPUT3*5.12911753661319+$INPUT4*-12.6894763621734+$INPUT5*6.49308839988831+$INPUT6*-2.55296066493966+$INPUT7*1.34622155522146+$INPUT8*8.64907058824782+$INPUT9*7.74938433378528+$INPUT10*-6.65180459445959+$INPUT11*1.90638369258598+$INPUT12*1.22589921696929+$INPUT13*-15.9158983113855+$INPUT14*1.84446109318197+$INPUT15*25.3273327841634+$INPUT16*-20.4539436086399+$INPUT17*-9.61109523104861+$INPUT18*1.0702650738091+$INPUT19*3.25314320042794+$INPUT20*-31.2679303728988+$INPUT21*-19.9654296034266+$INPUT22*-24.6640283161583+$INPUT23*0.849954749886675+$INPUT24*-0.167466135536721+$INPUT25*6.13115261959909 , \ 
        HIDDEN12 = 1/(1+exp(-HNEURON_POT12)) , \ 
        HNEURON_POT13=1.55554026691519 +$INPUT1*3.09910256090697+$INPUT2*3.54655408671534+$INPUT3*0.385712412335261+$INPUT4*-0.490656579354898+$INPUT5*0.765104692549656+$INPUT6*-8.06092581343161+$INPUT7*-7.77329330601318+$INPUT8*-3.85387482548376+$INPUT9*-3.00453923549561+$INPUT10*-1.15438679756936+$INPUT11*3.66699194209878+$INPUT12*4.43855599862419+$INPUT13*3.10661359344617+$INPUT14*5.02562595216277+$INPUT15*1.84126729437638+$INPUT16*1.82038994209416+$INPUT17*1.38800309936794+$INPUT18*0.0126053855651734+$INPUT19*0.800310777687043+$INPUT20*-1.82544680564874+$INPUT21*-0.483491095713901+$INPUT22*-1.4113879306117+$INPUT23*0.361798144128799+$INPUT24*-2.1872917743425+$INPUT25*0.290670553036802 , \ 
        HIDDEN13 = 1/(1+exp(-HNEURON_POT13)) , \ 
        HNEURON_POT14=4.1527361503177 +$INPUT1*-11.038702036764+$INPUT2*4.40930246310713+$INPUT3*13.9557158424982+$INPUT4*-3.24081170797064+$INPUT5*-6.76442084038511+$INPUT6*11.8901362149431+$INPUT7*-1.45765861215557+$INPUT8*-9.69338518727026+$INPUT9*-11.9162251644541+$INPUT10*20.0439587782144+$INPUT11*-30.7587551071442+$INPUT12*-9.72706013824444+$INPUT13*10.133939599379+$INPUT14*16.807343455993+$INPUT15*19.3938616173976+$INPUT16*26.7860732863266+$INPUT17*-7.88137234876713+$INPUT18*-9.65248748322556+$INPUT19*5.05128570524705+$INPUT20*-37.7656602479955+$INPUT21*3.14216965570605+$INPUT22*14.8540777308466+$INPUT23*-4.79785636034287+$INPUT24*-6.79234251101639+$INPUT25*5.08006790331826 , \ 
        HIDDEN14 = 1/(1+exp(-HNEURON_POT14)) , \ 
        HNEURON_POT15=-3.73727915669187 +$INPUT1*-0.604392367544815+$INPUT2*15.4805645757976+$INPUT3*17.3855700876647+$INPUT4*6.1424728154991+$INPUT5*-26.3012580001922+$INPUT6*26.3745616903578+$INPUT7*9.76308783966788+$INPUT8*0.869128440797812+$INPUT9*-25.7763701074769+$INPUT10*13.7214242925851+$INPUT11*-12.9321558071592+$INPUT12*-21.993436808044+$INPUT13*-26.4204089109409+$INPUT14*7.02600984024716+$INPUT15*7.6517110753186+$INPUT16*-0.636237923776413+$INPUT17*3.72388449601772+$INPUT18*14.7299868506176+$INPUT19*24.935946887041+$INPUT20*-6.92672641168609+$INPUT21*-12.2764967780374+$INPUT22*-6.99429484278119+$INPUT23*-6.58990022560738+$INPUT24*-12.1070566897408+$INPUT25*11.8099526727642 , \ 
        HIDDEN15 = 1/(1+exp(-HNEURON_POT15)) , \ 
        HNEURON_POT16=0.976674347679507 +$INPUT1*3.52284822798253+$INPUT2*1.7982160025552+$INPUT3*6.0791173539169+$INPUT4*4.1680402834695+$INPUT5*-8.42279649156609+$INPUT6*8.47332648746393+$INPUT7*5.03646158584677+$INPUT8*-7.66298105000436+$INPUT9*-14.6446435569492+$INPUT10*-30.6390036026356+$INPUT11*-23.3026239896455+$INPUT12*-19.0739688543188+$INPUT13*2.08391833466624+$INPUT14*-10.8837395484177+$INPUT15*20.4144532890226+$INPUT16*17.8491200473375+$INPUT17*14.7505265338967+$INPUT18*8.70304616785856+$INPUT19*12.5465655449023+$INPUT20*13.5615024333134+$INPUT21*-6.48727612004327+$INPUT22*-2.62795721330894+$INPUT23*-9.02139718397353+$INPUT24*8.82279013594724+$INPUT25*5.14430988031092 , \ 
        HIDDEN16 = 1/(1+exp(-HNEURON_POT16)) , \ 
        HNEURON_POT17=0.912597084522871 +$INPUT1*-19.0811251159644+$INPUT2*-0.348693522255067+$INPUT3*21.5596283455365+$INPUT4*13.9436820410929+$INPUT5*-2.95614037220021+$INPUT6*0.157316427180096+$INPUT7*5.76477989827919+$INPUT8*4.00817948354449+$INPUT9*-11.271259209358+$INPUT10*-7.36891258650285+$INPUT11*17.7565678421675+$INPUT12*13.8032720113643+$INPUT13*6.10517674408298+$INPUT14*19.7337685041751+$INPUT15*-2.17453071677535+$INPUT16*7.15562451889018+$INPUT17*-0.152219415219357+$INPUT18*-23.07746542503+$INPUT19*-9.21582168320844+$INPUT20*30.7280894298037+$INPUT21*-6.07673086396446+$INPUT22*-19.0917809174891+$INPUT23*-8.56623924058111+$INPUT24*-13.1051377710312+$INPUT25*-18.2107216468314 , \ 
        HIDDEN17 = 1/(1+exp(-HNEURON_POT17)) , \ 
        HNEURON_POT18=12.5190096476215 +$INPUT1*9.3380650015091+$INPUT2*9.75173708202341+$INPUT3*9.58468800174739+$INPUT4*4.82974841254906+$INPUT5*1.07004062583881+$INPUT6*1.06895375350556+$INPUT7*2.1747173517027+$INPUT8*1.52464903475083+$INPUT9*8.40181011895365+$INPUT10*13.5951175939343+$INPUT11*-7.84959519160631+$INPUT12*-7.06524846573022+$INPUT13*-5.62333787504177+$INPUT14*-2.34388287185201+$INPUT15*-2.07590115447788+$INPUT16*3.21368449076138+$INPUT17*-1.14431747444999+$INPUT18*-2.07077040836649+$INPUT19*-2.10321774336056+$INPUT20*-8.48530770041274+$INPUT21*-5.72603147015411+$INPUT22*-3.79895560032962+$INPUT23*-3.68117134172467+$INPUT24*-8.6882817333568+$INPUT25*-4.09226303512048 , \ 
        HIDDEN18 = 1/(1+exp(-HNEURON_POT18)) , \ 
        HNEURON_POT19=-2.91177151725996 +$INPUT1*-5.89623789604119+$INPUT2*6.96765056499323+$INPUT3*14.4536375100836+$INPUT4*0.912961609207061+$INPUT5*-15.9784673012833+$INPUT6*1.64746399473695+$INPUT7*-2.02926692524622+$INPUT8*-22.4394451877112+$INPUT9*-4.93918058832762+$INPUT10*-11.9982509624543+$INPUT11*-14.8270617171525+$INPUT12*15.5912859060189+$INPUT13*26.8563182998218+$INPUT14*7.42345255919596+$INPUT15*-11.4532418382465+$INPUT16*22.563975389463+$INPUT17*-8.24914945422589+$INPUT18*-8.02458327706428+$INPUT19*-7.06477240497956+$INPUT20*11.7646416397618+$INPUT21*-3.38454173974786+$INPUT22*-12.3218587011304+$INPUT23*-10.9224319189174+$INPUT24*3.75735981226026+$INPUT25*27.6344533891725 , \ 
        HIDDEN19 = 1/(1+exp(-HNEURON_POT19)) , \ 
        HNEURON_POT20=-4.19940889584187 +$INPUT1*-7.25702481585994+$INPUT2*-7.05677439289611+$INPUT3*-2.26503533023081+$INPUT4*-4.20175504731705+$INPUT5*-2.66457480276187+$INPUT6*10.6706131904715+$INPUT7*10.6504098930215+$INPUT8*5.66468845547658+$INPUT9*3.80271096503479+$INPUT10*0.27773652720215+$INPUT11*3.22464277527595+$INPUT12*0.420081146387879+$INPUT13*3.34487552888797+$INPUT14*0.732216430974211+$INPUT15*3.15706053872004+$INPUT16*-3.11027833154389+$INPUT17*-2.30005302472783+$INPUT18*-3.48735359557768+$INPUT19*-1.42400583518926+$INPUT20*7.30805065960291+$INPUT21*-3.57625313529795+$INPUT22*-1.6325162855313+$INPUT23*-3.23666908857579+$INPUT24*1.10196286233206+$INPUT25*-7.9547593369289 , \ 
        HIDDEN20 = 1/(1+exp(-HNEURON_POT20)) , \ 
        OUT_POT1=-0.122768579867097 +HIDDEN1*48.8525750139931+HIDDEN2*71.8872888213764+HIDDEN3*65.6823442311719+HIDDEN4*-58.3124598638801+HIDDEN5*-71.7565192270811+HIDDEN6*38.8440259554948+HIDDEN7*93.5380043186853+HIDDEN8*-71.4963824905939+HIDDEN9*-16.9662682561399+HIDDEN10*49.0655447591857+HIDDEN11*-22.6867235309914+HIDDEN12*-38.9722242225886+HIDDEN13*-16.9903475239266+HIDDEN14*-51.3602644515382+HIDDEN15*-41.8150634773656+HIDDEN16*31.4157617395814+HIDDEN17*-37.8671143585832+HIDDEN18*-29.5884985850625+HIDDEN19*-68.4572194571887+HIDDEN20*27.3672917995754) 
    $OUT_NEURON1 = 1/(1+exp(-OUT_POT1))
    """)

    nnet = NET.substitute(vars)
    grass.mapcalc(nnet)
    for i in range(1, 26):
        varname = 'INPUT'+str(i)
        # grass.run_command('g.remove', type='rast', name=vars[varname], flags='f')



if __name__ == "__main__":
    options, flags = grass.parser()
    main(options, flags)
    sys.exit(0)

